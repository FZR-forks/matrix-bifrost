Refactor profile handing for the gateway handler